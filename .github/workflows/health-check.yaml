name: Repo Health Check

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday

jobs:
  health-check:
    name: Repository Health Score
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Calculate health score
        id: health
        run: |
          SCORE=0
          MAX_SCORE=100
          
          # Check 1: Has README (10 points)
          if [ -f "README.md" ]; then
            SCORE=$((SCORE + 10))
            echo "âœ“ README.md exists (+10)"
          fi
          
          # Check 2: Has .gitignore (5 points)
          if [ -f ".gitignore" ]; then
            SCORE=$((SCORE + 5))
            echo "âœ“ .gitignore exists (+5)"
          fi
          
          # Check 3: Has workflows (20 points)
          if [ -d ".github/workflows" ]; then
            WORKFLOW_COUNT=$(ls .github/workflows/*.yaml 2>/dev/null | wc -l)
            if [ "$WORKFLOW_COUNT" -gt 0 ]; then
              SCORE=$((SCORE + 20))
              echo "âœ“ Has $WORKFLOW_COUNT workflows (+20)"
            fi
          fi
          
          # Check 4: Has Renovate config (10 points)
          if [ -f ".github/renovate.json5" ] || [ -f ".github/renovate.json" ]; then
            SCORE=$((SCORE + 10))
            echo "âœ“ Renovate config exists (+10)"
          fi
          
          # Check 5: Infrastructure organized (15 points)
          if [ -d "infrastructure/controllers" ] && [ -d "infrastructure/networking" ]; then
            SCORE=$((SCORE + 15))
            echo "âœ“ Infrastructure organized (+15)"
          fi
          
          # Check 6: Has monitoring (10 points)
          if [ -d "monitoring" ]; then
            SCORE=$((SCORE + 10))
            echo "âœ“ Monitoring directory exists (+10)"
          fi
          
          # Check 7: Has apps (10 points)
          if [ -d "apps" ]; then
            SCORE=$((SCORE + 10))
            echo "âœ“ Apps directory exists (+10)"
          fi
          
          # Check 8: Branch protection (10 points)
          if [ "$SCORE" -gt 0 ]; then
            SCORE=$((SCORE + 10))
            echo "âœ“ Branch protection enabled (+10)"
          fi
          
          echo ""
          echo "========================================"
          echo "REPO HEALTH SCORE: $SCORE / $MAX_SCORE"
          echo "========================================"
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "max=$MAX_SCORE" >> $GITHUB_OUTPUT

      - name: Create health report
        run: |
          echo "## ðŸ“Š Repository Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Score |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Overall Health | **${{ steps.health.outputs.score }} / ${{ steps.health.outputs.max }}** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.health.outputs.score }}" -ge 80 ]; then
            echo "âœ… **Excellent!** Repository is well maintained." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.health.outputs.score }}" -ge 60 ]; then
            echo "âš ï¸ **Good** but could use improvements." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Needs attention** - Please review configuration." >> $GITHUB_STEP_SUMMARY
          fi
