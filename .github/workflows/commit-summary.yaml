name: Commit Summary

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  summary:
    name: Generate Commit Summary
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate summary
        id: summary
        run: |
          # Get commits
          COMMITS=$(git log --oneline -10)
          
          # Get changed files
          CHANGED=$(git diff --name-only origin/main...HEAD 2>/dev/null || git diff --name-only HEAD~5..HEAD)
          
          # Count additions/deletions
          STATS=$(git diff --stat origin/main...HEAD 2>/dev/null || git diff --stat HEAD~5..HEAD)
          
          echo "=== Recent Commits ===" >> $GITHUB_STEP_SUMMARY
          echo "$COMMITS" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "=== Changed Files ===" >> $GITHUB_STEP_SUMMARY
          echo "$CHANGED" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "=== Change Stats ===" >> $GITHUB_STEP_SUMMARY
          echo "$STATS" >> $GITHUB_STEP_SUMMARY
          
          echo "summary=$COMMITS" >> $GITHUB_OUTPUT

      - name: Post summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ steps.summary.outputs.summary }}`;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“‹ Commit Summary\n\n\`\`\`\n${summary}\n\`\`\``
            });
